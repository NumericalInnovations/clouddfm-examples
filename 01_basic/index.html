<!DOCTYPE html>
<html>
  <head>
    <title>PCB Preflight API Basic Example</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
  </head>
  <body>

    <h1>PCB Preflight API Basic Example</h1>

    <form id="form1">
      <input type="hidden" name="async" value="false"/>
      <input type="hidden" name="output" value="files"/>
      <input type="hidden" name="save_input" value="false"/>
      <input type="hidden" name="send_email" value="true"/>
      <input type="hidden" name="timeout" value="60"/>
      <p>Upload Multiple Files <input type="file" name="files" id="files" multiple/></p>
      <p><input type="submit" id="submitButton" value="Submit"/></p>
    </form>

    <div id="results"></div>

    <script>
      // This should NOT be public, you can regenerate keys if it is abused.
      // See the webserver code for a better example how to integrate CloudDFM to your website
      const PCBPREFLIGHT_API_KEY = 'YOUR-PCBPREFLIGHT-API-KEY'; 
      let job_id_hash = null;
      let resultsElement = null;
      let job = null

      document.addEventListener("DOMContentLoaded", init);

      function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      function init() {
        document.getElementById("submitButton").addEventListener("click", async function(e) {
          resultsElement = document.getElementById('results');
          e.preventDefault();
          submit()
        })
      }

      async function submit() {
        resultsElement.textContent = 'Please wait ...';

        const formData = new FormData(document.getElementById('form1'));

        try {
          const response = await fetch('https://www.pcbpreflight.com/api/v1/job', {
            method: 'POST',
            headers: {'Authorization': PCBPREFLIGHT_API_KEY},
            body: formData,
            cache: 'no-cache',
          });

          const data = await response.json();
          if (data.ok === 1) {
            job_id_hash = data.result.job_id_hash;
            resultsElement.innerHTML = '';
            resultsElement.innerHTML += `job_id_hash = ${job_id_hash} <br/>`;
            while(job==null || job.status!='complete') {
              await delay(1000)
              resultsElement.innerHTML += `Checking ... <br/>`;
              job = await checkJob()
            }
            onJobComplete()
          } else {
            resultsElement.textContent = data.err.message;
          }
        } catch (err) {
          resultsElement.textContent = err.statusText;
        }
      }

      async function checkJob() {
        const response = await fetch(`https://www.pcbpreflight.com/api/v1/job/${job_id_hash}`, {
          method: 'GET',
          headers: {'Authorization': PCBPREFLIGHT_API_KEY},
          cache: 'no-cache',
        });

        const data = await response.json();
        if (data.ok === 1) return data.result
        throw Error(data.error)
      }

      function onJobComplete() {
        console.error(job)
        for(var i=0;i<job.outputs.length;i++) {
          let src = job.outputs[i];
          if(src.ext=='jpg'||src.ext=='png') {
            resultsElement.innerHTML += '<img src="'+src.url+'" width="320"/><br/>';
          }
        }
        resultsElement.innerHTML += 'DONE<br/>';
      }
    </script>
  </body>
</html>
