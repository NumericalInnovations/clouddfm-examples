<!DOCTYPE html>
<html>
  <head>
    <title>PCB Preflight API Basic Example</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
  </head>
  <body>

    <h1>PCB Preflight API Basic Example</h1>

    <form id="form1">
      <input type="hidden" name="async" value="false"/>
      <input type="hidden" name="output" value="files"/>
      <input type="hidden" name="save_input" value="false"/>
      <input type="hidden" name="send_email" value="true"/>
      <input type="hidden" name="timeout" value="60"/>
      <p>Upload Multiple Files <input type="file" name="files" id="files" multiple/></p>
      <p><input type="submit" id="submitButton" value="Submit"/></p>
    </form>
    <br/>

    <div id="result1Container" style="display:none">
      <div>Get Job ID, then keep checking if status='complete'</div>
      <pre id="result1" style="width:90%;padding:8px;border:1px solid black;font-family:'Courier New', Courier, monospace;overflow:hidden"></pre>
    </div>
    <br/>

    <div id="result2Container" style="display:none">
      <div>Result of processing</div>
      <pre id="result2" style="width:90%;padding:8px;border:1px solid black;font-family:'Courier New', Courier, monospace;overflow:hidden"></pre>
    </div>

    <script>
      // This should NOT be public, you can regenerate keys if it is abused.
      // See the webserver code for a better example how to integrate CloudDFM to your website
      const PCBPREFLIGHT_API_KEY = 'YOUR-PCB-PREFLIGHT-API-KEY'; 
      let job = null
      let job_id_hash = null;

      document.addEventListener("DOMContentLoaded", init);

      function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      function init() {
        document.getElementById("submitButton").addEventListener("click", async function(e) {
          e.preventDefault();
          submit()
        })
      }

      async function submit() {
        const formData = new FormData(document.getElementById('form1'));

        try {
          const response = await fetch('https://www.pcbpreflight.com/api/v1/job', {
            method: 'POST',
            headers: {'Authorization': PCBPREFLIGHT_API_KEY},
            body: formData,
            cache: 'no-cache',
          });

          const data = await response.json();
          if (data.ok === 1) {
            job_id_hash = data.result.job_id_hash;
            document.getElementById('result1Container').style.display = 'block'
            const result1 = document.getElementById('result1');
            result1.textContent = JSON.stringify(data.result,null,2)

            // Keep trying to get the job until status=='complete'
            while(job==null || job.status!='complete') {
              await delay(1000)
              job = await checkJob()
              updateResult()
            }
          } else {
            result1.textContent = data.err.message;
          }
        } catch (err) {
          result1.textContent = err.statusText;
        }
      }

      async function checkJob() {
        const response = await fetch(`https://www.pcbpreflight.com/api/v1/job/${job_id_hash}`, {
          method: 'GET',
          headers: {'Authorization': PCBPREFLIGHT_API_KEY},
          cache: 'no-cache',
        });

        const data = await response.json();
        if (data.ok === 1) return data.result
        throw Error(data.error)
      }

      function updateResult() {
        document.getElementById('result2Container').style.display = 'block';
        document.getElementById('result2').textContent = JSON.stringify(job,null,2)
      }
    </script>
  </body>
</html>
